---
layout: post
title: '"Active" Federation with Silverlight, WCF, and WIF'
date: '2011-10-06T00:30:00-07:00'
tags:
- WCF
- Silverlight
tumblr_url: http://hashtagfail.com/post/11094642160/wcf-wif-silverlight-active-federation
---
<p>In <a title="RIA Services active federation" href="http://hashtagfail.com/posts/2018/10/19/2011-05-12-ria-services-active-federation">this post</a> I provided a description of the active federation authentication pattern and shared how to implement it with RIA Services. In this post I will show how to do the same but use a regular WCF service instead of a RIA Services DomainService. I am including the diagram from my last post, with some minimal modifications here.</p>
<p><img alt="Active federation flow with Silverlight, WCF, and WIF" src="{{ site.baseurl }}/assets/posts/tumblr/tumblr_lsmur0bKCd1qccglw.png"/></p>
<p>I should clarify why I am putting the word active in quotation marks. The following will only make sense if you understand the difference between passive and active federation, which is outlined in the post linked above. In the <strong>passive </strong>federation case, the user never enters their credentials in the client app; they are redirected to the STS of the identity provider organization. This way the user is providing their credentials directly to the party they trust, and not to the app, which they may not trust. In the <strong>active </strong>federation case, they actually provide their credentials to the client app, and trust that the app will not be malicious, and will simply forward those credentials to the STS of the identity provider. The client app is responsible for creating a secure login UI, and also for securely transmitting the credentials to the STS. That is a lot of responsibility, and in traditional active federation scenarios, the client app uses <em>strong encryption</em> to guarantee the secure transfer of credentials. Still, lots of users may be reluctant to type in their credentials into a client app they don&rsquo;t trust.</p>
<p>In this example I show how to do the active federation flow, and my client app does collect the credentials. I have hand-rolled my login UI, and cannot make any guarantees as to how secure it actually is. For the communication with the server, I simply use HTTPS, instead of more comprehensive message-level security. So my example reaps the convenience of the active flow (no need to redirect the user to a different page, login happens in-app), however may not provide the traditional security guarantees associated with it. Hence &ldquo;active&rdquo;. </p>
<p><em>What I provide here may be perfectly secure for many scenarios but is up to you, the developer, to assess if this particular setup satisfies the requirements of your users and your organization. </em></p>
<p>Now some specifics of the sample. It’s a simple app that can draw squares on the screen according to a <a title="Fibonacci numbers on Wikipedia" href="http://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci</a> tiling. There are two registered users: <strong>fabrikam\yavor</strong> and <strong>fabrikam\test</strong> and the password for both of them is <strong>12345</strong>. Both can log into the app, however only the fabrikam\yavor user is in the role <strong>Calculators</strong>, meaning people who can carry out calculations on the service. This is enforced by the following attribute on the service&rsquo;s <strong>GetSequence</strong> method.</p>
<pre class="brush: csharp">[PrincipalPermission(SecurityAction.Demand, Authenticated = true, Role = "Calculators")]
public int[] GetSequence(int max)</pre>
<p>The bottom line here is that even though we have a STS with external user authentication, we kept authorization local to our app (we use ASP.NET roles). That’s a choice you can make as a developer - you can also externalize the user roles (or claims) as part of the STS, or keep them local.</p>
<p>There are lots of extra details in the app, which you’ll see by exploring the source.</p>
<p><strong><a title="Download sample" href="http://archive.msdn.microsoft.com/Project/Download/FileDownload.aspx?ProjectName=silverlightws&amp;DownloadId=15744">The code is available here.</a></strong> The solution should be fairly self-contained, so all you need to run it is Visual Studio 2010 and the <a title="WIF download" href="http://msdn.microsoft.com/en-us/security/aa570351">Windows Identity Foundation Runtime</a>. Here are some additional notes on the structure of the sample:</p>
<ul><li>First, please run the included <strong>SetupCertificates.cmd</strong> script inside the <strong>Scripts</strong> folder</li>
<li>The solution will create two applications in your local IIS instance: <strong>FibonacciService </strong>and <strong>IdentityProviderAndSts</strong>. Make sure you launch Visual Studio as <strong>Administrator</strong>, so it has permission to create those. Also make sure you enable <strong>HTTPS</strong> so both of the applications in the <strong>IIS Manager</strong></li>
</ul><p>I want to credit the folks behind the <a title="Download the Identity Developer Training Kit" href="http://go.microsoft.com/fwlink/?LinkId=148795">Identity Developer Training Kit</a>, from where I shamelessly stole some code.</p>
